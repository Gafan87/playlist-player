<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mafia Video Crossfade</title>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    .video-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    .video-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 1;
      z-index: 1;
      transition: opacity 3s ease-in-out;
    }

    .video-wrapper.fade-out {
      opacity: 0;
      z-index: 0;
    }

    .video-wrapper.fade-in {
      opacity: 1;
      z-index: 2;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.7);
      padding: 20px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }

    .timer-display {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #00ff00;
      text-align: center;
      min-width: 150px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      padding: 10px 15px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    button:hover {
      background: #0b7dda;
    }

    button:active {
      background: #0056b3;
    }

    .status {
      font-size: 12px;
      margin-top: 10px;
      color: #ffff00;
    }
  </style>
</head>
<body>

<div class="video-container">
  <!-- –ü–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ -->
  <div id="video1Wrapper" class="video-wrapper fade-in">
    <div id="player1"></div>
  </div>

  <!-- –í—Ç–æ—Ä–æ–µ –≤–∏–¥–µ–æ (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–∞—Ä–∞–Ω–µ–µ, –Ω–µ–≤–∏–¥–∏–º–æ) -->
  <div id="video2Wrapper" class="video-wrapper">
    <div id="player2"></div>
  </div>
</div>

<div class="controls">
  <div class="timer-display" id="timerDisplay">15s</div>
  <div class="status" id="status">–°—Ç–∞—Ç—É—Å: –≥–æ—Ç–æ–≤</div>
  <div class="button-group">
    <button onclick="startSequence()">–°—Ç–∞—Ä—Ç</button>
    <button onclick="stopSequence()">–°—Ç–æ–ø</button>
    <button onclick="toggleFullscreen()">Fullscreen</button>
  </div>
</div>

<script>
  // –ö–æ–Ω—Ñ–∏–≥ —Ç—Ä—ç–∫–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const tracks = [
    {
      id: 'S69w0zMW-A0',
      startSeconds: 0,
      endSeconds: 15,
      duration: 15,
      name: 'Titanium (15s)'
    },
    {
      id: 'MvofQDdXSR4',
      startSeconds: 15,
      endSeconds: 90,
      duration: 75,
      name: 'EDM Mix (75s)'
    }
  ];

  let currentTrackIndex = 0;
  let player1, player2;
  let isPlaying = false;
  let timerId = null;
  let remainingTime = 0;
  const FADE_DURATION = 3000; // 3 —Å–µ–∫ –Ω–∞ fade
  const FADE_START_BEFORE_END = 3; // –Ω–∞—á–∞—Ç—å fade –∑–∞ 3 —Å–µ–∫ –¥–æ –∫–æ–Ω—Ü–∞

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è YouTube IFrame API
  window.onYouTubeIframeAPIReady = function() {
    console.log('YouTube API ready');
    
    player1 = new YT.Player('player1', {
      width: '100%',
      height: '100%',
      videoId: tracks[0].id,
      playerVars: {
        'autoplay': 0,
        'controls': 0,
        'modestbranding': 1,
        'rel': 0,
        'showinfo': 0,
        'fs': 1,
        'iv_load_policy': 3,
        'start': tracks[0].startSeconds,
        'end': tracks[0].endSeconds
      },
      events: {
        'onReady': onPlayer1Ready,
        'onStateChange': onPlayer1StateChange,
        'onError': onPlayerError
      }
    });

    player2 = new YT.Player('player2', {
      width: '100%',
      height: '100%',
      videoId: tracks[1].id,
      playerVars: {
        'autoplay': 0,
        'controls': 0,
        'modestbranding': 1,
        'rel': 0,
        'showinfo': 0,
        'fs': 1,
        'iv_load_policy': 3,
        'start': tracks[1].startSeconds,
        'end': tracks[1].endSeconds
      },
      events: {
        'onReady': onPlayer2Ready,
        'onStateChange': onPlayer2StateChange,
        'onError': onPlayerError
      }
    });
  };

  function onPlayer1Ready(event) {
    console.log('Player 1 ready');
    updateStatus('Player 1 –≥–æ—Ç–æ–≤');
  }

  function onPlayer2Ready(event) {
    console.log('Player 2 ready (loaded but hidden)');
    updateStatus('Player 2 –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω');
  }

  function onPlayer1StateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) {
      console.log('Player 1: PLAYING');
      updateStatus('–í–∏–¥–µ–æ 1: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
    } else if (event.data === YT.PlayerState.ENDED) {
      console.log('Player 1: ENDED');
      updateStatus('–í–∏–¥–µ–æ 1: –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
    }
  }

  function onPlayer2StateChange(event) {
    if (event.data === YT.PlayerState.PLAYING) {
      console.log('Player 2: PLAYING');
      updateStatus('–í–∏–¥–µ–æ 2: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
    }
  }

  function onPlayerError(event) {
    console.error('YouTube Player Error:', event.data);
    updateStatus('‚ùå –û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ: ' + event.data);
  }

  function startSequence() {
    if (isPlaying) return;

    isPlaying = true;
    currentTrackIndex = 0;
    playTrack(0);
  }

  function playTrack(index) {
    if (index >= tracks.length) {
      console.log('–ü–ª–µ–π–ª–∏—Å—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è');
      updateStatus('–ü–ª–µ–π–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω');
      isPlaying = false;
      return;
    }

    const currentTrack = tracks[index];
    const nextTrack = tracks[index + 1];

    console.log(`Playing track ${index}: ${currentTrack.name}`);
    updateStatus(`‚ñ∂ ${currentTrack.name}`);

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ
    remainingTime = currentTrack.duration;
    updateTimerDisplay();

    // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ –Ω–∞ –ø–µ—Ä–µ–¥–Ω–µ–º –ø–ª–∞–Ω–µ
    document.getElementById('video1Wrapper').classList.remove('fade-out');
    document.getElementById('video1Wrapper').classList.add('fade-in');
    document.getElementById('video2Wrapper').classList.remove('fade-in');
    document.getElementById('video2Wrapper').classList.add('fade-out');

    player1.seekTo(currentTrack.startSeconds, true);
    player1.playVideo();

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä—ç–∫, –∑–∞–≥—Ä—É–∑–∏–º –µ–≥–æ –≤ —Ñ–æ–Ω
    if (nextTrack) {
      console.log(`Preloading next track: ${nextTrack.name}`);
      player2.cueVideoById({
        videoId: nextTrack.id,
        startSeconds: nextTrack.startSeconds,
        endSeconds: nextTrack.endSeconds
      });
    }

    // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
    clearInterval(timerId);
    timerId = setInterval(() => {
      remainingTime -= 0.1;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ—Ä–∞ –ª–∏ –Ω–∞—á–∏–Ω–∞—Ç—å fade (–∑–∞ 3 —Å–µ–∫ –¥–æ –∫–æ–Ω—Ü–∞)
      if (remainingTime <= FADE_START_BEFORE_END && nextTrack) {
        console.log(`FADE START: remainingTime=${remainingTime.toFixed(1)}s`);
        startCrossfade(index);
      }

      updateTimerDisplay();

      // –ü—Ä–æ–≤–µ—Ä–∫–∞: –∫–æ–Ω–µ—Ü —Ç—Ä—ç–∫–∞
      if (remainingTime <= 0) {
        clearInterval(timerId);
        playTrack(index + 1);
      }
    }, 100);
  }

  function startCrossfade(currentIndex) {
    const nextTrack = tracks[currentIndex + 1];

    if (!nextTrack) return;

    console.log('Starting crossfade transition...');
    updateStatus(`üîÑ –ü–µ—Ä–µ—Ö–æ–¥: ${nextTrack.name}`);

    // –ù–∞—á–∞—Ç—å –≤—Ç–æ—Ä–æ–µ –≤–∏–¥–µ–æ
    player2.playVideo();

    // –ü–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ –≤ —Ñ–æ–Ω (fade out)
    document.getElementById('video1Wrapper').classList.add('fade-out');
    document.getElementById('video1Wrapper').classList.remove('fade-in');

    // –í—Ç–æ—Ä–æ–µ –≤–∏–¥–µ–æ –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω (fade in)
    document.getElementById('video2Wrapper').classList.add('fade-in');
    document.getElementById('video2Wrapper').classList.remove('fade-out');

    // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è fade –ø–æ–º–µ–Ω—è—Ç—å –ø–ª–µ–µ—Ä –º–µ—Å—Ç–∞–º–∏
    setTimeout(() => {
      console.log('Crossfade complete, swapping players');
      swapPlayers();
    }, FADE_DURATION);
  }

  function swapPlayers() {
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –ø–ª–µ–µ—Ä—ã –≤ DOM
    const wrapper1 = document.getElementById('video1Wrapper');
    const wrapper2 = document.getElementById('video2Wrapper');

    // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    const temp = wrapper1.innerHTML;
    wrapper1.innerHTML = wrapper2.innerHTML;
    wrapper2.innerHTML = temp;

    // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –ø–ª–µ–µ—Ä—ã (–ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ —Ç–µ–ø–µ—Ä—å –≤ –¥—Ä—É–≥–∏—Ö div)
    const tempPlayer = player1;
    player1 = player2;
    player2 = tempPlayer;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã
    wrapper1.classList.remove('fade-out', 'fade-in');
    wrapper1.classList.add('fade-in');
    wrapper2.classList.remove('fade-out', 'fade-in');
    wrapper2.classList.add('fade-out');

    console.log('Players swapped');
  }

  function stopSequence() {
    clearInterval(timerId);
    player1.stopVideo();
    player2.stopVideo();
    isPlaying = false;
    remainingTime = 0;
    updateTimerDisplay();
    updateStatus('‚èπ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
  }

  function updateTimerDisplay() {
    const seconds = Math.max(0, remainingTime.toFixed(1));
    document.getElementById('timerDisplay').textContent = `${seconds}s`;
  }

  function updateStatus(message) {
    document.getElementById('status').textContent = `–°—Ç–∞—Ç—É—Å: ${message}`;
  }

  function toggleFullscreen() {
    const container = document.querySelector('.video-container');
    if (!document.fullscreenElement) {
      container.requestFullscreen().catch(err => {
        console.error('Fullscreen error:', err);
      });
    } else {
      document.exitFullscreen();
    }
  }

  // –ó–∞–ø—É—Å–∫ API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('load', () => {
    console.log('Page loaded, YouTube API should initialize...');
  });
</script>

</body>
</html>
